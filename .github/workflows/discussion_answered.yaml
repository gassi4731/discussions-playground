name: DiscussionNotification

on:
  discussion:
    types: [answered]

jobs:
  discussion:
    if: github.event.discussion.category.name == "Q&A"
    runs-on: ubuntu-22.04
    steps:
      - name: Read config.json
        id: config
        uses: jaywcjlove/github-action-read-file@main
        with:
          path: config.json

      - name: Get Discussion Action
        run: |
          echo "DISCUSSION_URL=${{ github.event.discussion.html_url }}" >> $GITHUB_ENV
          echo "DISCUSSION_TITLE=${{ github.event.discussion.title }}" >> $GITHUB_ENV
          echo "DISCUSSION_BODY=${{ github.event.discussion.body }}" >> $GITHUB_ENV
          echo "DISCUSSION_USER_NAME=${{ github.event.discussion.user.login }}" >> $GITHUB_ENV
          echo "DISCUSSION_ANSER_BODY=${{ github.event.answer.body }}" >> $GITHUB_ENV
      
      - name: Set ChannelId
        run: |
          echo "CHANNELID=${{ fromJson(steps.config.outputs.content)['instructorChannelId'] }}" >> $GITHUB_ENV
      
      - name: Send GitHub Action trigger data to Slack workflow
        id: slack
        uses: slackapi/slack-github-action@v1.16.0
        with:
          channel-id: "${{ env.CHANNELID }}"
          payload: |
            {
              "attachments": [
                  {
                    "mrkdwn_in": ["text"],
                      "color": "#36a64f",
                      "pretext": "<@here>\n:tada: 質問が回答されました:tada: ",
                      "title": "${{ env.DISCUSSION_TITLE }}",
                      "title_link": "${{ env.DISCUSSION_URL }}",
                      "text": "${{ env.DISCUSSION_BODY }}\n"
                      "fields": [
                        {
                            "title": "Answer",
                            "value": "${{ env.DISCUSSION_ANSER_BODY }}",
                            "short": false
                        },
                      ]
                  }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
